---
- name: "5.5.1.1 | PATCH | Ensure password expiration is 90"
  block:
    - name: "5.5.1.1 | PATCH | Ensure password expiration is 90 | set /etc/login.defs PASS_MAX_DAYS"
      lineinfile:
          state: present
          dest: /etc/login.defs
          regexp: '^PASS_MAX_DAYS'
          line: "PASS_MAX_DAYS {{ rhel7cis_pass['max_days'] }}"

    - name: "AUTOMATED | 5.5.1.2 | PATCH | Ensure password expiration is 90 | Set existing users PASS_MAX_DAYS"
      command: chage --maxdays {{ rhel7cis_pass['max_days'] }} {{ item }}
      failed_when: false
      with_items:
        - "{{ rhel7cis_passwd | selectattr('uid', '>=', 1000) | map(attribute='id') | list }}"

- name: "5.5.1.2 | PATCH | Ensure minimum days between password changes is configured"
  block:
    - name: "5.5.1.2 | PATCH | Ensure minimum days between password changes is configured | Set /etc/login.defs PASS_MIN_DAYS"
      lineinfile:
          state: present
          dest: /etc/login.defs
          regexp: '^PASS_MIN_DAYS'
          line: "PASS_MIN_DAYS {{ rhel7cis_pass['min_days'] }}"

    - name: "5.5.1.2 | PATCH | Ensure minimum days between password changes is configured | Set existing users PASS_MIN_DAYS"
      command: chage --mindays {{ rhel7cis_pass['min_days'] }} {{ item }}
      failed_when: false
      with_items:
        - "{{ rhel7cis_passwd | selectattr('uid', '>=', 1000) | map(attribute='id') | list }}"


- name: "5.5.1.3 | PATCH | Ensure password expiration warning days is 7 or more"
  block: 
    - name: "5.5.1.3 | PATCH | Ensure password expiration warning days is 7 or more | Set /etc/login.defs PASS_WARN_AGE"
      lineinfile:
          state: present
          dest: /etc/login.defs
          regexp: '^PASS_WARN_AGE'
          line: "PASS_WARN_AGE {{ rhel7cis_pass['warn_age'] }}"

    - name: "5.5.1.3 | PATCH | Ensure password expiration warning days is 7 or more | Set existing users PASS_WARN_AGE"
      command: chage --warndays {{ rhel7cis_pass['warn_age'] }} {{ item }}
      failed_when: false
      with_items:
        - "{{ rhel7cis_passwd | selectattr('uid', '>=', 1000) | map(attribute='id') | list }}"

- name: "5.5.1.5 | PATCH | Ensure all users last password change date is in the past"
  block:
      - name: "5.5.1.5 | AUDIT | Ensure all users last password change date is in the past | Get current date in Unix Time"
        shell: echo $(($(date --utc --date "$1" +%s)/86400))
        failed_when: false
        changed_when: false
        check_mode: false
        register: rhel7cis_5_5_1_5_current_unix_time

      - name: "5.5.1.5 | AUDIT | Ensure all users last password change date is in the past | Get list of users with last changed pw date in the future"
        shell: "cat /etc/shadow | awk -F: '{if($3>{{ rhel7cis_5_5_1_5_current_unix_time.stdout }})print$1}'"
        check_mode: false
        changed_when: false
        register: rhel7cis_5_5_1_5_user_list

      - name: "5.5.1.5 | AUDIT | Ensure all users last password change date is in the past | Alert no pw change in the future exist"
        debug:
            msg: "Good News! All accounts have PW change dates that are in the past"
        when: rhel7cis_5_5_1_5_user_list.stdout | length == 0

      - name: "5.5.1.5 | AUDIT | Ensure all users last password change date is in the past | Alert on accounts with pw change in the future"
        debug:
            msg: "WARNING!! The following accounts have the last PW change date in the future: {{ rhel7cis_5_5_1_5_user_list.stdout_lines }}"
        when:
            - rhel7cis_5_5_1_5_user_list.stdout | length > 0
            - not rhel7cis_futurepwchgdate_autofix

      - name: "5.5.1.5 | PATCH | Ensure all users last password change date is in the past | Fix accounts with pw change in the future"
        shell: passwd --expire {{ item }}
        when:
            - rhel7cis_5_5_1_5_user_list | length > 0
            - rhel7cis_futurepwchgdate_autofix
        with_items:
            - "{{ rhel7cis_5_5_1_5_user_list.stdout_lines }}"