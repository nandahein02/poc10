---

- name: "5.4.1 | L1 | PATCH | Ensure password creation requirements are configured"
  lineinfile:
      state: present
      dest: "/etc/security/pwquality.conf"
      regexp: '^{{ item.key }}'
      line: '{{ item.key }} = {{ item.value }}'
  with_items:
      - { key: 'minlen', value: '14' }
      - { key: 'minclass', value: '4' }
      - { key: 'lcredit', value: '0' }
      - { key: 'ucredit', value: '0' }
      - { key: 'dcredit', value: '0' }
      - { key: 'ocredit', value: '0' }

- name: |
              " 5.4.2 | PATCH | Ensure lockout for failed password attempts is configured | Copy system/passowrd-auth to system/password-auth-local
                5.4.3 | L1 | PATCH | Ensure password hashing algorithm is SHA-512
                5.4.4 | PATCH | Ensure password reuse is limited | Copy system/password-auth to system/password-auth-local"
  template:
    src: 'templates/{{ item.src }}'
    dest: '/etc/pam.d/{{ item.dest }}'
    owner: root
    group: root
    mode: 0644
    backup: yes
  with_items:
    - { src: 'password-auth.j2', dest: 'password-auth' }
    - { src: 'system-auth.j2', dest: 'system-auth' }

- name: |
              " 5.4.2 | PATCH | Ensure lockout for failed password attempts is configured | Copy system/passowrd-auth to system/password-auth-local
                5.4.3 | L1 | PATCH | Ensure password hashing algorithm is SHA-512
                5.4.4 | PATCH | Ensure password reuse is limited | Copy system/password-auth to system/password-auth-local"
  copy:
      src: "/etc/pam.d/{{ item }}"
      dest: "/etc/pam.d/{{ item }}-local"
      remote_src: true
      owner: root
      group: root
      mode: '0644'
  loop:
      - "system-auth"
      - "password-auth"

- name: |
        " 5.4.2 | PATCH | Ensure lockout for failed password attempts is configured | Setup symbolic link
          5.4.3 | L1 | PATCH | Ensure password hashing algorithm is SHA-512
          5.4.4 | PATCH | Ensure password reuse is limited | Setup symbolic link"
  file:
      src: "/etc/pam.d/{{ item }}-local"
      dest: "/etc/pam.d/{{ item }}"
      state: link
      force: true
  loop:
      - "system-auth"
      - "password-auth"